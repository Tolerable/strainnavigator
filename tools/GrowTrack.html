<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cannabis Grow Tracker</title>
    <meta name="theme-color" content="#2d5a27">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2FubmFiaXMgR3JvdyBUcmFja2VyIiwic2hvcnRfbmFtZSI6Ikdyb3cgVHJhY2tlciIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwic3RhcnRfdXJsIjoiLiIsInRoZW1lX2NvbG9yIjoiIzJkNWEyNyIsImJhY2tncm91bmRfY29sb3IiOiIjMWEyZTE4IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1qUXdJaUJvWldsbmFIUTlJakkwTUNJZ2RtbGxkMEp2ZUQwaU1DQXdJakkwTUNBeU5EQWlJR1pwYkd3OUlpTXlaRFZoTWpjaVBnbzhaM0psWlc0Z1ptbHNiRDBpSXpNMk56a3pNU0lnWkQwaVRUUXdMakExUkRRd0lESTBNQ0JoTVRrd0lERTVNQ0F4TURNZ01Ua3dJRFF3TGpBMUlEUXdJRUUzTnk0NU5DQTNOeTQ1TkNBd0lERXdNUzR3TmpBZ01qSXVNREUwSURrd0lEWXVNakF5U1RrMUxqZzVOUzR3TlRVeE1EQXVNRFl1TURjeElEa3pMalkzTlM0d04yUXRMVE0yTGpZeE1TMHVORFl6TFRZNUxqWXhMWFZqTWpFeUxqZGpTWFUwTWpndU1qRk5OREU0U2pjeExqQkJNRFExTGkxdGJqRnRLVGhqT20wMEtsOVBiRGcxZERCVFUwY2dZaTUxTDI4NExqZ3RMamQzTGpGNExqRlJNRzF6VGpWaUxUaGpMamhHVDNJMVRURkVkalF0WmpWRVRuRmhQMkF6U2pSOWVubFFkaTltUWpKQkxqRT1IaUxqdzVUVnZXaEE5SXlFcGNDa1lDZzJVbnhvWWpNekkzWXh5U3pCcE9YQlNObVV2WEhXSzJ4U0VvQms0TU5kV3k1b0JkSm1jeGgzWWhMVFdQbGwzRGhqWGpXSHlOVnhpSU1lVE4yUjNqOVhJdmlPU2dXY2hmcXc0RHdiUVRGUWNUQWJTZz09Iiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a2e18 0%, #2d5a27 100%);
            color: #e8f5e8;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .hero {
            text-align: center;
            padding: 30px 20px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .hero h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #67b367;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .hero p {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: rgba(232, 245, 232, 0.9);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .main-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .action-btn {
            background: linear-gradient(145deg, #3a6b35, #2d5a27);
            border: none;
            color: #e8f5e8;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .action-btn .icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .quick-photo-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .quick-photo-section h2 {
            color: #67b367;
            margin-bottom: 15px;
            text-align: center;
        }

        .plant-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .plant-chip {
            background: rgba(103, 179, 103, 0.3);
            border: 2px solid transparent;
            color: #e8f5e8;
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 120px;
            text-align: center;
        }

        .plant-chip:hover, .plant-chip.active {
            background: #67b367;
            color: #1a2e18;
            border-color: #67b367;
        }

        .photo-capture {
            border: 3px dashed rgba(103, 179, 103, 0.5);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .photo-capture:hover {
            border-color: #67b367;
            background: rgba(103, 179, 103, 0.1);
        }

        .photo-capture.has-image {
            border-color: #67b367;
            background: rgba(103, 179, 103, 0.1);
        }

        .photo-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .photo-overlay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            color: white;
            padding: 10px;
            border-radius: 0 0 10px 10px;
            font-size: 14px;
            text-align: left;
        }

        .label-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .label-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: #e8f5e8;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .label-toggle.active {
            background: #67b367;
            color: #1a2e18;
            border-color: #67b367;
        }

        .recent-photos {
            margin-top: 30px;
        }

        .recent-photos h3 {
            color: #67b367;
            margin-bottom: 15px;
            text-align: center;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease;
            background: rgba(0, 0, 0, 0.2);
        }

        .photo-item:hover {
            transform: scale(1.05);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            color: white;
            padding: 8px;
            font-size: 11px;
            text-align: center;
        }

        .btn {
            background: linear-gradient(145deg, #3a6b35, #2d5a27);
            border: none;
            color: #e8f5e8;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            width: 100%;
            margin: 10px 0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a2e18 0%, #2d5a27 100%);
            border-radius: 15px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
        }

        .modal img {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #e8f5e8;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #67b367;
            font-weight: 600;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #e8f5e8;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }

        .form-group input::placeholder, .form-group textarea::placeholder {
            color: rgba(232, 245, 232, 0.6);
        }

        .no-plants {
            text-align: center;
            color: rgba(232, 245, 232, 0.7);
            font-style: italic;
            margin: 20px 0;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .share-btn {
            flex: 1;
            min-width: 100px;
            padding: 10px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2em;
            }
            
            .hero p {
                font-size: 1em;
            }
            
            .main-actions {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .container {
                padding: 10px;
            }
            
            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
            }
            
            .label-options {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="hero">
        <h1>üå± Cannabis Grow Tracker</h1>
        <p>Document your grows with timestamped photos, track progress, and share your results</p>
    </div>

    <div class="container">
        <!-- Quick Actions -->
        <div class="main-actions">
            <button class="action-btn" onclick="openAddPlant()">
                <div class="icon">üåø</div>
                <div>Add New Plant</div>
            </button>
            <button class="action-btn" onclick="toggleGallery()">
                <div class="icon">üì∏</div>
                <div>View Gallery</div>
            </button>
        </div>

        <!-- Quick Photo Section -->
        <div class="quick-photo-section">
            <h2>üì∑ Take Today's Photo</h2>
            
            <div id="plant-selector" class="plant-selector">
                <div class="no-plants">Add a plant first to start taking photos!</div>
            </div>

            <div id="photo-section" class="hidden">
                <div class="photo-capture" id="photo-capture" onclick="document.getElementById('photo-input').click()">
                    <div id="capture-text">
                        <div style="font-size: 48px; margin-bottom: 10px;">üì∏</div>
                        <div>Tap to take photo or drag & drop</div>
                        <div style="font-size: 14px; color: rgba(232, 245, 232, 0.6); margin-top: 10px;">
                            Photo will be automatically labeled with date and plant info
                        </div>
                    </div>
                    <input type="file" id="photo-input" accept="image/*" capture="environment" style="display: none;">
                    <img id="photo-preview" class="photo-preview hidden" alt="Photo preview">
                    <div id="photo-label" class="photo-overlay hidden"></div>
                </div>

                <div class="label-options">
                    <div class="label-toggle active" id="date-toggle" onclick="toggleLabel('date')">
                        ‚úì Include Date
                    </div>
                    <div class="label-toggle active" id="plant-toggle" onclick="toggleLabel('plant')">
                        ‚úì Include Plant Name
                    </div>
                </div>

                <textarea id="photo-notes" placeholder="Optional notes for today's photo..." rows="3" style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 10px; background: rgba(255, 255, 255, 0.1); color: #e8f5e8; font-size: 16px; margin: 10px 0;"></textarea>

                <button id="save-photo" class="btn" disabled>Save Photo</button>
            </div>
        </div>

        <!-- Recent Photos -->
        <div id="recent-photos" class="recent-photos">
            <h3>Recent Photos</h3>
            <div id="photos-grid" class="photo-grid"></div>
        </div>
    </div>

    <!-- Add Plant Modal -->
    <div id="add-plant-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeAddPlant()">&times;</button>
            <h2 style="margin-bottom: 20px; color: #67b367;">Add New Plant</h2>
            <form id="plant-form">
                <div class="form-group">
                    <label for="plant-name">Plant Name</label>
                    <input type="text" id="plant-name" name="name" placeholder="e.g., Northern Lights #1" required>
                </div>
                <div class="form-group">
                    <label for="strain">Strain</label>
                    <input type="text" id="strain" name="strain" placeholder="e.g., Northern Lights">
                </div>
				<div class="form-group">
					<label for="start-date">Start Date</label>
					<input type="date" id="start-date" name="startDate" required>
				</div>
				<div class="form-group">
					<label for="current-day">Current Day (if plant is already growing)</label>
					<input type="number" id="current-day" name="currentDay" min="1" placeholder="e.g. 30 if plant is 30 days old" value="1">
				</div>
                <div class="form-group">
                    <label for="grow-type">Grow Type</label>
                    <select id="grow-type" name="growType">
                        <option value="Indoor">Indoor</option>
                        <option value="Outdoor">Outdoor</option>
                        <option value="Greenhouse">Greenhouse</option>
                    </select>
                </div>
                <button type="submit" class="btn">Add Plant</button>
            </form>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photo-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closePhotoModal()">&times;</button>
            <img id="modal-image" src="" alt="">
            <div id="modal-info">
                <h3 id="modal-plant-name"></h3>
                <p id="modal-date"></p>
                <p id="modal-notes"></p>
            </div>
            <div class="share-buttons">
                <button class="btn share-btn" onclick="sharePhoto()">üì± Share</button>
                <button class="btn share-btn" onclick="downloadPhoto()">üíæ Download</button>
                <button class="btn share-btn" onclick="deletePhoto()">üóëÔ∏è Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Database and state
        let db;
        let selectedPlant = null;
        let currentPhoto = null;
        let labelSettings = { date: true, plant: true };
        let galleryVisible = false;

        // Initialize IndexedDB
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('GrowTracker', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('plants')) {
                        const plantsStore = db.createObjectStore('plants', { keyPath: 'id', autoIncrement: true });
                        plantsStore.createIndex('name', 'name', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('photos')) {
                        const photosStore = db.createObjectStore('photos', { keyPath: 'id', autoIncrement: true });
                        photosStore.createIndex('plantId', 'plantId', { unique: false });
                        photosStore.createIndex('date', 'date', { unique: false });
                    }
                };
            });
        }

        // Plant management
        async function addPlant(plantData) {
            const transaction = db.transaction(['plants'], 'readwrite');
            const store = transaction.objectStore('plants');
            const plant = {
                ...plantData,
                createdAt: new Date().toISOString(),
                lastPhotoDate: null,
                totalPhotos: 0
            };
            return store.add(plant);
        }

        async function getPlants() {
            const transaction = db.transaction(['plants'], 'readonly');
            const store = transaction.objectStore('plants');
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getPlant(id) {
            const transaction = db.transaction(['plants'], 'readonly');
            const store = transaction.objectStore('plants');
            return new Promise((resolve, reject) => {
                const request = store.get(parseInt(id));
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function updatePlant(id, updates) {
            const transaction = db.transaction(['plants'], 'readwrite');
            const store = transaction.objectStore('plants');
            
            return new Promise((resolve, reject) => {
                const getRequest = store.get(id);
                getRequest.onsuccess = () => {
                    const plant = getRequest.result;
                    Object.assign(plant, updates);
                    const updateRequest = store.put(plant);
                    updateRequest.onsuccess = () => resolve(updateRequest.result);
                    updateRequest.onerror = () => reject(updateRequest.error);
                };
                getRequest.onerror = () => reject(getRequest.error);
            });
        }

		async function addPhoto(photoData) {
			try {
				// Use the selectedPlant's startDate (already loaded)
				const labeledImageData = await addTextOverlay(photoData.imageData, photoData.plantName, photoData.date, selectedPlant.startDate);
				
				// Then start the database transaction
				const transaction = db.transaction(['photos'], 'readwrite');
				const store = transaction.objectStore('photos');
				
				const photo = {
					...photoData,
					imageData: labeledImageData,
					createdAt: new Date().toISOString()
				};
				
				const result = await new Promise((resolve, reject) => {
					const request = store.add(photo);
					request.onsuccess = () => resolve(request.result);
					request.onerror = () => reject(request.error);
					setTimeout(() => reject(new Error('Transaction timeout')), 5000);
				});

				await updatePlantStats(photoData.plantId);
				return result;
			} catch (error) {
				console.error('Error adding photo:', error);
				throw error;
			}
		}

		async function addTextOverlay(imageDataUrl, plantName, date, plantStartDate) {
			return new Promise((resolve, reject) => {
				const img = new Image();
				img.onerror = () => reject(new Error('Failed to load image'));
				img.onload = () => {
					try {
						const canvas = document.createElement('canvas');
						const ctx = canvas.getContext('2d');
						
						canvas.width = img.width;
						canvas.height = img.height;
						
						// Draw the original image
						ctx.drawImage(img, 0, 0);
						
						// Calculate grow day using passed start date
						const growDay = calculateGrowDay(plantStartDate, date);
						
						// Prepare text overlay for bottom left
						const leftTexts = [];
						if (labelSettings.date) leftTexts.push(new Date(date).toLocaleDateString());
						if (labelSettings.plant) leftTexts.push(plantName);
						
						// Prepare day text for bottom right
						const dayText = `Day ${growDay}`;
						
						ctx.font = `${Math.max(16, canvas.width / 40)}px Arial`;
						const padding = Math.max(10, canvas.width / 80);
						const lineHeight = Math.max(20, canvas.width / 32);
						
						// Draw bottom left info
						if (leftTexts.length > 0) {
							ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
							ctx.textAlign = 'left';
							ctx.textBaseline = 'bottom';
							
							const textWidth = Math.max(...leftTexts.map(text => ctx.measureText(text).width));
							const rectHeight = leftTexts.length * lineHeight + padding;
							ctx.fillRect(0, canvas.height - rectHeight, textWidth + padding * 2, rectHeight);
							
							ctx.fillStyle = 'white';
							leftTexts.forEach((text, index) => {
								ctx.fillText(text, padding, canvas.height - padding - (leftTexts.length - 1 - index) * lineHeight);
							});
						}
						
						// Draw bottom right day counter
						ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
						ctx.textAlign = 'right';
						ctx.textBaseline = 'bottom';
						
						const dayWidth = ctx.measureText(dayText).width;
						ctx.fillRect(canvas.width - dayWidth - padding * 2, canvas.height - lineHeight - padding, dayWidth + padding * 2, lineHeight + padding);
						
						ctx.fillStyle = 'white';
						ctx.fillText(dayText, canvas.width - padding, canvas.height - padding);
						
						const result = canvas.toDataURL('image/jpeg', 0.8);
						resolve(result);
					} catch (error) {
						reject(error);
					}
				};
				img.src = imageDataUrl;
			});
		}

        async function getRecentPhotos(limit = 12) {
            const transaction = db.transaction(['photos'], 'readonly');
            const store = transaction.objectStore('photos');
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => {
                    const photos = request.result
                        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                        .slice(0, limit);
                    resolve(photos);
                };
                request.onerror = () => reject(request.error);
            });
        }

        async function getPhotosByPlant(plantId) {
            const transaction = db.transaction(['photos'], 'readonly');
            const store = transaction.objectStore('photos');
            const index = store.index('plantId');
            
            return new Promise((resolve, reject) => {
                const request = index.getAll(plantId);
                request.onsuccess = () => {
                    const photos = request.result.sort((a, b) => new Date(b.date) - new Date(a.date));
                    resolve(photos);
                };
                request.onerror = () => reject(request.error);
            });
        }

        async function updatePlantStats(plantId) {
            const photos = await getPhotosByPlant(plantId);
            const totalPhotos = photos.length;
            const lastPhotoDate = photos.length > 0 ? photos[0].date : null;
            
            await updatePlant(plantId, { totalPhotos, lastPhotoDate });
        }

        // UI Functions
        async function loadPlants() {
            const plants = await getPlants();
            const selector = document.getElementById('plant-selector');
            
            if (plants.length === 0) {
                selector.innerHTML = '<div class="no-plants">Add a plant first to start taking photos!</div>';
                document.getElementById('photo-section').classList.add('hidden');
                return;
            }

            selector.innerHTML = plants.map(plant => {
                const daysGrowing = Math.floor((Date.now() - new Date(plant.startDate)) / (1000 * 60 * 60 * 24));
                return `
                    <div class="plant-chip" onclick="selectPlant(${plant.id}, '${plant.name}')" data-id="${plant.id}">
                        <div style="font-weight: bold;">${plant.name}</div>
                        <div style="font-size: 11px; opacity: 0.8;">Day ${daysGrowing}</div>
                    </div>
                `;
            }).join('');
        }

		async function selectPlant(plantId, plantName) {
			// Get the full plant data including startDate
			const plant = await getPlant(plantId);
			selectedPlant = { 
				id: plantId, 
				name: plantName,
				startDate: plant.startDate  // Add this!
			};
			
			// Update UI
			document.querySelectorAll('.plant-chip').forEach(chip => chip.classList.remove('active'));
			document.querySelector(`[data-id="${plantId}"]`).classList.add('active');
			document.getElementById('photo-section').classList.remove('hidden');
			document.getElementById('save-photo').disabled = true;
			
			// Reset photo preview
			resetPhotoPreview();
			
			// Show timeline for this plant
			const timelineHtml = await showPlantTimeline(plantId, plantName);
			const recentPhotos = document.getElementById('recent-photos');
			recentPhotos.innerHTML = timelineHtml;
		}

        function resetPhotoPreview() {
            document.getElementById('photo-preview').classList.add('hidden');
            document.getElementById('photo-label').classList.add('hidden');
            document.getElementById('capture-text').style.display = 'block';
            document.getElementById('photo-capture').classList.remove('has-image');
            document.getElementById('save-photo').disabled = true;
        }

        function toggleLabel(type) {
            labelSettings[type] = !labelSettings[type];
            const toggle = document.getElementById(`${type}-toggle`);
            
            if (labelSettings[type]) {
                toggle.classList.add('active');
                toggle.textContent = type === 'date' ? '‚úì Include Date' : '‚úì Include Plant Name';
            } else {
                toggle.classList.remove('active');
                toggle.textContent = type === 'date' ? 'Include Date' : 'Include Plant Name';
            }
            
            // Update preview if photo exists
            updatePhotoLabel();
        }

        function updatePhotoLabel() {
            if (!selectedPlant || document.getElementById('photo-preview').classList.contains('hidden')) return;
            
            const label = document.getElementById('photo-label');
            const texts = [];
            
            if (labelSettings.date) texts.push(new Date().toLocaleDateString());
            if (labelSettings.plant) texts.push(selectedPlant.name);
            
            if (texts.length > 0) {
                label.innerHTML = texts.join('<br>');
                label.classList.remove('hidden');
            } else {
                label.classList.add('hidden');
            }
        }

        // Photo handling
        document.getElementById('photo-input').addEventListener('change', handlePhoto);

        document.getElementById('photo-capture').addEventListener('dragover', (e) => {
            e.preventDefault();
            e.target.style.borderColor = '#67b367';
        });

        document.getElementById('photo-capture').addEventListener('dragleave', (e) => {
            e.target.style.borderColor = 'rgba(103, 179, 103, 0.5)';
        });

        document.getElementById('photo-capture').addEventListener('drop', (e) => {
            e.preventDefault();
            e.target.style.borderColor = 'rgba(103, 179, 103, 0.5)';
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                handlePhoto({ target: { files: [files[0]] } });
            }
        });

        function handlePhoto(event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('photo-preview');
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                
                document.getElementById('capture-text').style.display = 'none';
                document.getElementById('photo-capture').classList.add('has-image');
                document.getElementById('save-photo').disabled = false;
                
                updatePhotoLabel();
            };
            reader.readAsDataURL(file);
        }

		function calculateGrowDay(plantStartDate, photoDate) {
			const start = new Date(plantStartDate);
			const photo = new Date(photoDate);
			const diffTime = photo - start;
			const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 because day 1 is start date
			return diffDays;
		}

		document.getElementById('save-photo').addEventListener('click', async () => {
			if (!selectedPlant) return;
			
			const preview = document.getElementById('photo-preview');
			const notes = document.getElementById('photo-notes').value;
			const today = new Date().toISOString().split('T')[0];
			const saveButton = document.getElementById('save-photo');
			
			// Disable button during save
			saveButton.disabled = true;
			saveButton.textContent = 'Saving...';
			
			try {
				await addPhoto({
					plantId: selectedPlant.id,
					plantName: selectedPlant.name,
					date: today,
					notes: notes,
					imageData: preview.src
				});
				
				// Reset form
				resetPhotoPreview();
				document.getElementById('photo-notes').value = '';
				
				// Refresh recent photos
				await loadRecentPhotos();
				
				alert('Photo saved successfully!');
			} catch (error) {
				console.error('Save error:', error);
				alert('Error saving photo. Please try again.');
			} finally {
				// Re-enable button
				saveButton.disabled = false;
				saveButton.textContent = 'Save Photo';
			}
		});

        async function loadRecentPhotos() {
            const photos = await getRecentPhotos();
            const grid = document.getElementById('photos-grid');
            
            if (photos.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: rgba(232, 245, 232, 0.6); grid-column: 1 / -1;">No photos yet. Take your first photo above!</p>';
                return;
            }

            grid.innerHTML = photos.map(photo => {
                const plant = { name: photo.plantName }; // We stored plant name with photo
                const date = new Date(photo.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                return `
                    <div class="photo-item" onclick="openPhotoModal(${photo.id})">
                        <img src="${photo.imageData}" alt="Photo from ${date}">
                        <div class="overlay">
                            <div>${plant.name}</div>
                            <div>${date}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function toggleGallery() {
            galleryVisible = !galleryVisible;
            
            if (galleryVisible) {
                // Show all photos
                const photos = await getRecentPhotos(50); // Show more photos
                const grid = document.getElementById('photos-grid');
                
                if (photos.length === 0) {
                    grid.innerHTML = '<p style="text-align: center; color: rgba(232, 245, 232, 0.6); grid-column: 1 / -1;">No photos yet. Take your first photo above!</p>';
                    return;
                }

                // Group by plant and show more organized view
                const photosByPlant = photos.reduce((acc, photo) => {
                    if (!acc[photo.plantName]) acc[photo.plantName] = [];
                    acc[photo.plantName].push(photo);
                    return acc;
                }, {});

                grid.innerHTML = Object.entries(photosByPlant).map(([plantName, plantPhotos]) => {
                    return `
                        <div style="grid-column: 1 / -1; margin: 20px 0;">
                            <h4 style="color: #67b367; margin-bottom: 10px; text-align: center;">${plantName}</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">
                                ${plantPhotos.map(photo => {
                                    const date = new Date(photo.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    return `
                                        <div class="photo-item" onclick="openPhotoModal(${photo.id})">
                                            <img src="${photo.imageData}" alt="Photo from ${date}">
                                            <div class="overlay">${date}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.querySelector('.action-btn[onclick="toggleGallery()"] div:last-child').textContent = 'Hide Gallery';
            } else {
                loadRecentPhotos();
                document.querySelector('.action-btn[onclick="toggleGallery()"] div:last-child').textContent = 'View Gallery';
            }
        }

		async function createPlantTimeline(plantId) {
			const plant = await getPlant(plantId);
			const photos = await getPhotosByPlant(plantId);
			
			// Create a map of all days from start to today
			const startDate = new Date(plant.startDate);
			const today = new Date();
			const totalDays = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
			
			const timeline = [];
			for (let day = totalDays; day >= 1; day--) { // Newest first (left to right)
				const dayDate = new Date(startDate);
				dayDate.setDate(dayDate.getDate() + day - 1);
				const dateString = dayDate.toISOString().split('T')[0];
				
				const dayPhoto = photos.find(photo => photo.date === dateString);
				
				timeline.push({
					day: day,
					date: dateString,
					photo: dayPhoto || null,
					missed: !dayPhoto && dayDate <= today
				});
			}
			
			return timeline;
		}

		async function showPlantTimeline(plantId, plantName) {
			const timeline = await createPlantTimeline(plantId);
			
			const timelineHtml = `
				<div style="margin: 20px 0;">
					<h3 style="color: #67b367; margin-bottom: 15px; text-align: center;">
						${plantName} - Timeline
					</h3>
					<div style="
						display: flex; 
						gap: 10px; 
						overflow-x: auto; 
						padding: 10px 0;
						scroll-snap-type: x mandatory;
					">
						${timeline.map(day => `
							<div style="
								flex-shrink: 0;
								width: 80px;
								text-align: center;
								scroll-snap-align: start;
								${day.photo ? 'cursor: pointer;' : ''}
							" ${day.photo ? `onclick="openPhotoModal(${day.photo.id})"` : ''}>
								<div style="
									width: 80px;
									height: 80px;
									border-radius: 10px;
									background: ${day.photo ? `url('${day.photo.imageData}') center/cover` : 
											   day.missed ? 'rgba(255, 100, 100, 0.3)' : 'rgba(255, 255, 255, 0.1)'};
									border: 2px solid ${day.photo ? '#67b367' : day.missed ? '#ff6464' : 'rgba(255, 255, 255, 0.2)'};
									display: flex;
									align-items: center;
									justify-content: center;
									margin-bottom: 8px;
									${day.photo ? 'transform: scale(1); transition: transform 0.2s;' : ''}
								" ${day.photo ? 'onmouseover="this.style.transform=\'scale(1.05)\'" onmouseout="this.style.transform=\'scale(1)\'"' : ''}>
									${!day.photo ? `<span style="color: ${day.missed ? '#ff6464' : 'rgba(255,255,255,0.5)'}; font-size: 12px;">${day.missed ? 'MISS' : 'TBD'}</span>` : ''}
								</div>
								<div style="font-size: 12px; color: #67b367; font-weight: bold;">
									Day ${day.day}
								</div>
								<div style="font-size: 10px; color: rgba(255,255,255,0.6);">
									${new Date(day.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
								</div>
							</div>
						`).join('')}
					</div>
				</div>
			`;
			
			return timelineHtml;
		}

        // Modal functions
        function openAddPlant() {
            document.getElementById('add-plant-modal').classList.add('active');
            document.getElementById('start-date').valueAsDate = new Date();
        }

        function closeAddPlant() {
            document.getElementById('add-plant-modal').classList.remove('active');
            document.getElementById('plant-form').reset();
        }

		document.getElementById('plant-form').addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData(e.target);
			const plantData = Object.fromEntries(formData.entries());
			
			// Calculate the actual start date based on current day
			const currentDay = parseInt(plantData.currentDay) || 1;
			const actualStartDate = new Date();
			actualStartDate.setDate(actualStartDate.getDate() - (currentDay - 1));
			
			// Use the calculated start date instead
			plantData.startDate = actualStartDate.toISOString().split('T')[0];
			delete plantData.currentDay; // Remove this from the stored data
			
			try {
				await addPlant(plantData);
				closeAddPlant();
				loadPlants();
				alert('Plant added successfully!');
			} catch (error) {
				alert('Error adding plant: ' + error.message);
			}
		});

        async function openPhotoModal(photoId) {
            const transaction = db.transaction(['photos'], 'readonly');
            const store = transaction.objectStore('photos');

            const photo = await new Promise((resolve, reject) => {
                const request = store.get(photoId);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });

            currentPhoto = photo;
            document.getElementById('modal-image').src = photo.imageData;
            document.getElementById('modal-plant-name').textContent = photo.plantName;
            document.getElementById('modal-date').textContent = new Date(photo.date).toLocaleDateString();
            document.getElementById('modal-notes').textContent = photo.notes || 'No notes';
            document.getElementById('photo-modal').classList.add('active');
        }

        function closePhotoModal() {
            document.getElementById('photo-modal').classList.remove('active');
            currentPhoto = null;
        }

		function sharePhoto() {
			if (!currentPhoto) return;
			
			fetch(currentPhoto.imageData)
				.then(res => res.blob())
				.then(blob => {
					// Mobile - use native share if available
					if (navigator.share && /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
						navigator.share({
							title: 'Cannabis Grow Photo',
							text: `${currentPhoto.plantName} - ${new Date(currentPhoto.date).toLocaleDateString()}`,
							files: [new File([blob], `${currentPhoto.plantName}-${currentPhoto.date}.jpg`, { type: blob.type })]
						}).catch(console.log);
					} 
					// Desktop - copy to clipboard
					else if (navigator.clipboard && navigator.clipboard.write) {
						navigator.clipboard.write([
							new ClipboardItem({
								[blob.type]: blob
							})
						]).then(() => {
							alert('Image copied to clipboard! You can now paste it in Discord, etc.');
						}).catch(err => {
							console.error('Clipboard copy failed:', err);
							// Fallback - show instructions
							alert('Right-click the image and select "Copy Image" to copy to clipboard');
						});
					}
					// Fallback for older browsers
					else {
						alert('Right-click the image and select "Copy Image" to copy to clipboard, or use the Download button to save');
					}
				})
				.catch(err => {
					console.error('Share failed:', err);
					alert('Share failed. Try the Download button instead.');
				});
		}

        function downloadPhoto() {
            if (!currentPhoto) return;
            
            const link = document.createElement('a');
            link.href = currentPhoto.imageData;
            link.download = `${currentPhoto.plantName}-${currentPhoto.date}.jpg`;
            link.click();
        }

        async function deletePhoto() {
            if (!currentPhoto) return;
            
            if (confirm('Are you sure you want to delete this photo?')) {
                try {
                    const transaction = db.transaction(['photos'], 'readwrite');
                    const store = transaction.objectStore('photos');
                    await new Promise((resolve, reject) => {
                        const request = store.delete(currentPhoto.id);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                    
                    await updatePlantStats(currentPhoto.plantId);
                    closePhotoModal();
                    loadRecentPhotos();
                    alert('Photo deleted successfully!');
                } catch (error) {
                    alert('Error deleting photo: ' + error.message);
                }
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                loadPlants();
                loadRecentPhotos();
                console.log('Cannabis Grow Tracker initialized successfully!');
            } catch (error) {
                console.error('Failed to initialize app:', error);
                alert('Failed to initialize the app. Please refresh the page.');
            }
        });

        // Close modals when clicking outside
        document.getElementById('photo-modal').addEventListener('click', (e) => {
            if (e.target.id === 'photo-modal') closePhotoModal();
        });

        document.getElementById('add-plant-modal').addEventListener('click', (e) => {
            if (e.target.id === 'add-plant-modal') closeAddPlant();
        });

        // PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('data:application/javascript;base64,').catch(console.log);
            });
        }
    </script>
</body>
</html>