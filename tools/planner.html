<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strain Breeding Planner - ᵗʰᵉ Rev™</title>
    <style>
        :root {
            --primary: #2D5E32;
            --primary-light: #68A357;
            --primary-dark: #1A3C20;
            --accent: #5D4A7E;
            --background: #F8F6E9;
            --text: #333;
            --text-light: #666;
            --border: #ddd;
            --count-bg: rgba(93, 74, 126, 0.1);
            --female-color: #E091B9;
            --male-color: #91B7E0;
            --auto-color: #FFB74D;
            --photo-color: #4DB6AC;
            --reg-color: #9575CD;
            --fem-color: #F06292;
            --fast-color: #4FC3F7;
            --limited-color: #FFC107;
            --rare-color: #9C27B0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .subtitle {
            font-size: 1.2rem;
            font-weight: 300;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 1rem;
        }
        
        .panel {
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .panel-header {
            background-color: var(--primary);
            color: white;
            padding: 0.6rem 1rem;
            font-weight: 500;
        }
        
        .panel-content {
            padding: 1rem;
        }
        
        /* Strain List Panel */
        .search-container {
            display: flex;
            margin-bottom: 0.8rem;
        }
        
        .search-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px 0 0 4px;
            font-size: 0.9rem;
        }
        
        .search-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-bottom: 0.8rem;
        }
        
        .filter-btn {
            background-color: #f0f0f0;
            border: none;
            padding: 0.2rem 0.6rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .filter-btn.active {
            background-color: var(--accent);
            color: white;
        }
        
        .strain-list-container {
            height: calc(100vh - 270px);
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 4px;
        }
        
        .strain-list {
            list-style: none;
        }
        
        .strain-card {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.15s;
        }
        
        .strain-card:hover {
            background-color: rgba(45, 94, 50, 0.05);
        }
        
        .strain-card.selected {
            background-color: rgba(45, 94, 50, 0.1);
            border-left: 3px solid var(--primary);
        }
        
        .strain-info {
            flex: 1;
        }
        
        .strain-name {
            font-weight: 500;
            margin-bottom: 0.1rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .strain-labels {
            display: flex;
            flex-wrap: wrap;
            gap: 0.2rem;
        }
        
        .strain-label {
            font-size: 0.6rem;
            padding: 0.05rem 0.3rem;
            border-radius: 2px;
            color: white;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .label-auto { background-color: var(--auto-color); }
        .label-photo { background-color: var(--photo-color); }
        .label-fem { background-color: var(--fem-color); }
        .label-reg { background-color: var(--reg-color); }
        .label-fast { background-color: var(--fast-color); }
        .label-limited { background-color: var(--limited-color); }
        .label-rare { background-color: var(--rare-color); }
        
        .strain-count {
            background-color: var(--count-bg);
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--accent);
            min-width: 24px;
            text-align: center;
        }
        
        .strain-actions {
            display: flex;
            gap: 0.3rem;
            margin-top: 1rem;
        }
        
        .btn {
            padding: 0.3rem 0.6rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: background 0.15s;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-accent {
            background-color: var(--accent);
            color: white;
        }
        
        .btn-accent:hover {
            background-color: #4a3a66;
        }
        
        /* Strain Detail Panel */
        .strain-detail-panel {
            margin-bottom: 1rem;
            display: none;
        }
        
        .strain-detail-panel.active {
            display: block;
        }
        
        .strain-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .strain-detail-title {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--primary-dark);
        }
        
        .strain-detail-breeder {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .strain-detail-labels {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-bottom: 0.8rem;
        }
        
        .strain-detail-label {
            font-size: 0.7rem;
            padding: 0.1rem 0.5rem;
            border-radius: 3px;
            color: white;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .strain-detail-genetics {
            margin-bottom: 0.8rem;
            padding: 0.5rem;
            background-color: rgba(0, 0, 0, 0.02);
            border-radius: 4px;
        }
        
        .parent-label {
            font-size: 0.8rem;
            color: var(--text-light);
        }
        
        .parent-female {
            color: var(--female-color);
            font-weight: 500;
        }
        
        .parent-male {
            color: var(--male-color);
            font-weight: 500;
        }
        
        .strain-detail-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.8rem;
        }
        
        .stat-item {
            background-color: rgba(0, 0, 0, 0.02);
            padding: 0.4rem;
            border-radius: 3px;
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--text-light);
        }
        
        .stat-value {
            font-weight: 500;
        }
        
        /* Breeding Planner Panel */
        .planner-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .breeding-groups {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .breeding-group {
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            height: fit-content;
        }
        
        .breeding-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .breeding-group-title {
            width: 100%;
            padding: 0.3rem;
            border: 1px solid transparent;
            font-weight: 500;
            background: transparent;
        }
        
        .breeding-group-title:focus {
            outline: none;
            border-color: var(--border);
            background: white;
        }
        
        .breeding-group-actions {
            display: flex;
            gap: 0.3rem;
        }
        
        .btn-sm {
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
        }
        
        .btn-clear {
            background-color: #ff9800;
            color: white;
        }
        
        .btn-clear:hover {
            background-color: #f57c00;
        }
        
        .btn-remove {
            background-color: #f44336;
            color: white;
        }
        
        .btn-remove:hover {
            background-color: #d32f2f;
        }
        
        .breeding-group-content {
            min-height: 150px;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .breeding-group-content.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 0.9rem;
            font-style: italic;
            border: 2px dashed #eee;
            border-radius: 4px;
            margin: 0.5rem;
        }
        
        .strain-chip {
            display: inline-flex;
            align-items: center;
            background-color: white;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.3rem 0.5rem;
            margin: 0 0.3rem 0.3rem 0;
            font-size: 0.85rem;
            position: relative;
            max-width: 100%;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .strain-chip:hover {
            background-color: rgba(45, 94, 50, 0.05);
        }
        
        .strain-chip-name {
            margin-right: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 150px;
        }
        
        .strain-chip-type {
            display: flex;
            gap: 0.1rem;
        }
        
        .chip-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .indicator-photo { background-color: var(--photo-color); }
        .indicator-auto { background-color: var(--auto-color); }
        .indicator-reg { background-color: var(--reg-color); }
        .indicator-fem { background-color: var(--fem-color); }
        .indicator-fast { background-color: var(--fast-color); }
        
        .strain-chip-remove {
            color: #aaa;
            font-size: 0.7rem;
            margin-left: 0.3rem;
            cursor: pointer;
        }
        
        .strain-chip-remove:hover {
            color: #f44336;
        }
        
        .cross-results {
            padding: 0.5rem;
        }
        
        .cross-results-title {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }
        
        .cross-item {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            background-color: rgba(93, 74, 126, 0.05);
        }
        
        .cross-name {
            font-weight: 500;
        }
        
        .cross-compatibility {
            font-size: 0.8rem;
            margin-top: 0.2rem;
        }
        
        .compatibility-good {
            color: #4CAF50;
        }
        
        .compatibility-warning {
            color: #FFC107;
        }
        
        .compatibility-bad {
            color: #F44336;
        }
        
        .strain-tree {
            margin-top: 0.5rem;
        }
        
        .notes-field {
            width: 100%;
            min-height: 60px;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0 0 6px 6px;
            resize: vertical;
            font-family: inherit;
            font-size: 0.9rem;
        }
        
        /* Tree view styling */
        .tree-visualization {
            margin-top: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
        }
        
        .tree-container {
            min-height: 250px;
            position: relative;
        }
        
        /* Utility classes */
        .hidden {
            display: none;
        }
        
        footer {
            text-align: center;
            padding: 1rem;
            margin-top: 1rem;
            color: var(--text-light);
            font-size: 0.8rem;
        }
        
        @media (max-width: 1000px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .strain-list-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="subtitle">Strain Breeding Planner - ᵗʰᵉ Rev™</div>
    </header>
    
    <div class="container">
        <div class="main-layout">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Strain List Panel -->
                <div class="panel">
                    <div class="panel-header">Strain Collection</div>
                    <div class="panel-content">
                        <div class="search-container">
                            <input type="text" id="search-input" class="search-input" placeholder="Search strains...">
                            <button id="search-btn" class="search-btn">Search</button>
                        </div>
                        
                        <div class="filters">
                            <button class="filter-btn active" data-filter="all">All</button>
                            <button class="filter-btn" data-filter="reg">Reg</button>
                            <button class="filter-btn" data-filter="fem">Fem</button>
                            <button class="filter-btn" data-filter="auto">Auto</button>
                            <button class="filter-btn" data-filter="photo">Photo</button>
                            <button class="filter-btn" data-filter="fast">Fast</button>
                            <button class="filter-btn" data-filter="limited">Limited</button>
                            <button class="filter-btn" data-filter="rare">Rare</button>
                        </div>
                        
                        <div class="strain-list-container">
                            <ul id="strain-list" class="strain-list">
                                <!-- Strains will be loaded here -->
                                <li class="strain-card" data-id="loading">
                                    <div class="strain-info">
                                        <div class="strain-name">Loading strains...</div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Strain Detail Panel -->
                <div id="strain-detail" class="panel strain-detail-panel">
                    <div class="panel-header">Strain Details</div>
                    <div class="panel-content">
                        <div id="strain-detail-content">
                            <!-- Strain details will be loaded here -->
                        </div>
                        
                        <div class="strain-actions">
                            <button id="add-to-group-btn" class="btn btn-primary">Add to Group</button>
                            <button id="view-tree-btn" class="btn btn-accent">View Genetics</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="right-column">
                <!-- Breeding Planner Panel -->
                <div class="panel">
                    <div class="panel-header">Breeding Planner</div>
                    <div class="panel-content">
                        <p>Select strains and add them to breeding groups to plan your crosses.</p>
                        
                        <div class="planner-controls">
                            <button id="add-group-btn" class="btn btn-primary">+ Add Group</button>
                            <button id="save-all-btn" class="btn btn-accent">Save All</button>
                            <button id="load-btn" class="btn btn-accent">Load Saved</button>
                        </div>
                        
                        <div id="breeding-groups" class="breeding-groups">
                            <!-- Breeding groups will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        &copy; 2025 StrainNavigator.com | Collaborative Seed Collection Tracker
    </footer>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Config & State
            const sheetId = '1A7kFjfw6cjmQQOwz-5liWVGgFK0K5lwS8AfIZ_Zthbg';
            let allStrains = [];
            let selectedStrain = null;
            let activeGroupForAdd = null;
            let groupCounter = 0;
            
            // Cached Elements
            const strainList = document.getElementById('strain-list');
            const strainDetail = document.getElementById('strain-detail');
            const strainDetailContent = document.getElementById('strain-detail-content');
            const addToGroupBtn = document.getElementById('add-to-group-btn');
            const viewTreeBtn = document.getElementById('view-tree-btn');
            const breedingGroups = document.getElementById('breeding-groups');
            
            // Initialize
            init();
            
            function init() {
                loadStrains();
                setupEventListeners();
                addBreedingGroup(); // Add first group
            }
            
            function setupEventListeners() {
                // Search
                document.getElementById('search-btn').addEventListener('click', performSearch);
                document.getElementById('search-input').addEventListener('keyup', function(e) {
                    if (e.key === 'Enter') performSearch();
                });
                
                // Filters
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        filterStrains(this.dataset.filter);
                    });
                });
                
                // Planner Controls
                document.getElementById('add-group-btn').addEventListener('click', addBreedingGroup);
                document.getElementById('save-all-btn').addEventListener('click', saveBreedingPlan);
                document.getElementById('load-btn').addEventListener('click', loadBreedingPlan);
                
                // Strain Actions
                addToGroupBtn.addEventListener('click', showGroupSelectionModal);
                viewTreeBtn.addEventListener('click', toggleGeneticsTree);
            }
            
            // Data Loading Functions
            function loadStrains() {
                strainList.innerHTML = '<li class="strain-card"><div class="strain-info"><div class="strain-name">Loading strains...</div></div></li>';
                
                const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
                
                fetch(csvUrl)
                    .then(response => {
                        if (!response.ok) throw new Error('Network error');
                        return response.text();
                    })
                    .then(csv => {
                        allStrains = parseCSV(csv);
                        renderStrainList(allStrains);
                    })
                    .catch(error => {
                        console.error('Error loading data:', error);
                        strainList.innerHTML = '<li class="strain-card"><div class="strain-info"><div class="strain-name">Error loading strains. Please try again.</div></div></li>';
                    });
            }
            
            function parseCSV(csv) {
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(header => header.trim());
                
                const result = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    // Handle CSV with potential quoted values and commas
                    const values = parseCSVLine(lines[i]);
                    
                    if (values.length < 2 || !values[0].trim()) continue;
                    if (values[0].trim().toUpperCase() === 'STRAIN' || values[0].trim() === 'Unnamed Seed') continue;
                    
                    const entry = {};
                    for (let j = 0; j < headers.length; j++) {
                        entry[headers[j]] = j < values.length ? values[j].trim() : '';
                    }
                    
                    // Add unique ID
                    entry.id = `strain-${i}`;
                    result.push(entry);
                }
                
                return result;
            }
            
            function parseCSVLine(line) {
                const result = [];
                let inQuotes = false;
                let currentValue = '';
                let i = 0;
                
                while (i < line.length) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(currentValue);
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                    
                    i++;
                }
                
                result.push(currentValue);
                return result;
            }
            
            // Rendering Functions
            function renderStrainList(strains) {
                if (strains.length === 0) {
                    strainList.innerHTML = '<li class="strain-card"><div class="strain-info"><div class="strain-name">No strains found</div></div></li>';
                    return;
                }
                
                strainList.innerHTML = '';
                strains.forEach(strain => {
                    const strainName = strain.STRAIN || strain.Strain || strain.Name || strain.strain || 'Unnamed';
                    const seedType = strain['REG / FEM'] || strain.Type || strain.type || '';
                    const count = strain.COUNT || strain.Count || strain.count || '';
                    const status = strain.STATUS || strain.Status || strain.status || '';
                    
                    // Create type labels
                    const typeLabels = getTypeLabels(seedType, status);
                    let labelsHTML = '';
                    typeLabels.forEach(label => {
                        labelsHTML += `<span class="strain-label label-${label.toLowerCase()}">${label}</span>`;
                    });
                    
                    const listItem = document.createElement('li');
                    listItem.className = 'strain-card';
                    listItem.dataset.id = strain.id;
                    listItem.innerHTML = `
                        <div class="strain-info">
                            <div class="strain-name">${strainName}</div>
                            <div class="strain-labels">${labelsHTML}</div>
                        </div>
                        <div class="strain-count">${count}</div>
                    `;
                    
                    listItem.addEventListener('click', () => selectStrain(strain));
                    strainList.appendChild(listItem);
                });
            }
            
            function renderStrainDetail(strain) {
                const strainName = strain.STRAIN || strain.Strain || strain.Name || strain.strain || 'Unnamed';
                const breeder = strain.BREEDER || strain.Breeder || strain.breeder || 'Unknown';
                const seedType = strain['REG / FEM'] || strain.Type || strain.type || '';
                const count = strain.COUNT || strain.Count || strain.count || '';
                const status = strain.STATUS || strain.Status || strain.status || '';
                const parent1 = strain.PARENT1 || strain.parent1 || '';
                const parent2 = strain.PARENT2 || strain.parent2 || '';
                
                // Create type labels
                const typeLabels = getTypeLabels(seedType, status);
                let labelsHTML = '';
                typeLabels.forEach(label => {
                    labelsHTML += `<span class="strain-detail-label label-${label.toLowerCase()}">${label}</span>`;
                });
                
                // Create genetics section
                let geneticsHTML = '';
                if (parent1 || parent2) {
                    geneticsHTML = `
                        <div class="strain-detail-genetics">
                            <div class="parent-label">Genetics:</div>
                            ${parent1 ? `<div><span class="parent-female">${parent1}</span></div>` : ''}
                            ${parent2 ? `<div><span class="parent-male">${parent2}</span></div>` : ''}
                        </div>
                    `;
                }
                
                strainDetailContent.innerHTML = `
                    <div class="strain-detail-header">
                        <div class="strain-detail-title">${strainName}</div>
                    </div>
                    <div class="strain-detail-breeder">${breeder}</div>
                    <div class="strain-detail-labels">${labelsHTML}</div>
                    ${geneticsHTML}
                    <div class="strain-detail-stats">
                        <div class="stat-item">
                            <div class="stat-label">Count</div>
                            <div class="stat-value">${count}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Type</div>
                            <div class="stat-value">${seedType}</div>
                        </div>
                    </div>
                `;
                
                strainDetail.classList.add('active');
            }
            
            function getTypeLabels(type, status) {
                const labels = [];
                
                if (!type && !status) return labels;
                
                const lowerType = (type || '').toLowerCase();
                const lowerStatus = (status || '').toLowerCase();
                
                if (lowerType.includes('auto')) labels.push('AUTO');
                if (lowerType.includes('photo')) labels.push('PHOTO');
                if (lowerType.includes('fem')) labels.push('FEM');
                if (lowerType.includes('reg')) labels.push('REG');
                if (lowerType.includes('fast')) labels.push('FAST');
                
                if (lowerStatus.includes('limited')) labels.push('LIMITED');
                if (lowerStatus === 'rare') labels.push('RARE');
                
                return labels;
            }
            
            // Interaction Handlers
            function selectStrain(strain) {
                // Clear previous selection
                document.querySelectorAll('.strain-card.selected').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Update selection
                selectedStrain = strain;
                document.querySelector(`[data-id="${strain.id}"]`).classList.add('selected');
                
                renderStrainDetail(strain);
            }
            
            function performSearch() {
                const searchTerm= document.getElementById('search-input').value.trim().toLowerCase();
                
                if (!searchTerm) {
                    renderStrainList(allStrains);
                    return;
                }
                
                const filteredStrains = allStrains.filter(strain => {
                    const name = (strain.STRAIN || strain.Strain || strain.Name || '').toLowerCase();
                    const breeder = (strain.BREEDER || strain.Breeder || '').toLowerCase();
                    const type = (strain['REG / FEM'] || strain.Type || '').toLowerCase();
                    const parent1 = (strain.PARENT1 || strain.parent1 || '').toLowerCase();
                    const parent2 = (strain.PARENT2 || strain.parent2 || '').toLowerCase();
                    
                    return name.includes(searchTerm) || 
                           breeder.includes(searchTerm) || 
                           type.includes(searchTerm) || 
                           parent1.includes(searchTerm) || 
                           parent2.includes(searchTerm);
                });
                
                renderStrainList(filteredStrains);
            }
            
            function filterStrains(filter) {
                // Update active filter button
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === filter);
                });
                
                if (filter === 'all') {
                    renderStrainList(allStrains);
                    return;
                }
                
                const filteredStrains = allStrains.filter(strain => {
                    const type = (strain['REG / FEM'] || strain.Type || '').toLowerCase();
                    const status = (strain.STATUS || strain.Status || '').toLowerCase();
                    
                    if (filter === 'reg' && type.includes('reg')) return true;
                    if (filter === 'fem' && type.includes('fem')) return true;
                    if (filter === 'auto' && type.includes('auto')) return true;
                    if (filter === 'photo' && type.includes('photo')) return true;
                    if (filter === 'fast' && type.includes('fast')) return true;
                    if (filter === 'limited' && status.includes('limited')) return true;
                    if (filter === 'rare' && status === 'rare') return true;
                    
                    return false;
                });
                
                renderStrainList(filteredStrains);
            }
            
            // Breeding Group Functions
            function addBreedingGroup() {
                groupCounter++;
                const groupId = `group-${groupCounter}`;
                
                const groupElement = document.createElement('div');
                groupElement.className = 'breeding-group';
                groupElement.dataset.id = groupId;
                
                groupElement.innerHTML = `
                    <div class="breeding-group-header">
                        <input type="text" class="breeding-group-title" value="Breeding Project ${groupCounter}">
                        <div class="breeding-group-actions">
                            <button class="btn btn-sm btn-clear" data-action="clear" data-group="${groupId}">Clear</button>
                            <button class="btn btn-sm btn-remove" data-action="remove" data-group="${groupId}">Remove</button>
                        </div>
                    </div>
                    <div class="breeding-group-content empty" data-group="${groupId}">
                        Drop strains here
                    </div>
                    <div class="cross-results">
                        <div class="cross-results-title">Potential Crosses</div>
                        <div class="cross-results-content" data-results="${groupId}">
                            Add multiple strains to see crosses
                        </div>
                    </div>
                    <textarea class="notes-field" placeholder="Notes about this breeding project..."></textarea>
                `;
                
                breedingGroups.appendChild(groupElement);
                
                // Add event listeners
                const clearBtn = groupElement.querySelector('[data-action="clear"]');
                const removeBtn = groupElement.querySelector('[data-action="remove"]');
                
                clearBtn.addEventListener('click', () => clearBreedingGroup(groupId));
                removeBtn.addEventListener('click', () => removeBreedingGroup(groupId));
                
                // Make the group a drop target
                setupGroupDropTarget(groupId);
                
                return groupId;
            }
            
            function setupGroupDropTarget(groupId) {
                const groupContent = document.querySelector(`.breeding-group-content[data-group="${groupId}"]`);
                
                // Set up drop target for drag-and-drop from strain list
                groupContent.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    groupContent.classList.add('drag-over');
                });
                
                groupContent.addEventListener('dragleave', () => {
                    groupContent.classList.remove('drag-over');
                });
                
                groupContent.addEventListener('drop', (e) => {
                    e.preventDefault();
                    groupContent.classList.remove('drag-over');
                    
                    const data = e.dataTransfer.getData('text/plain');
                    if (data) {
                        try {
                            const strainData = JSON.parse(data);
                            addStrainToGroup(strainData.id, groupId);
                        } catch (error) {
                            console.error('Error parsing drag data:', error);
                        }
                    }
                });
            }
            
            function clearBreedingGroup(groupId) {
                const groupContent = document.querySelector(`.breeding-group-content[data-group="${groupId}"]`);
                groupContent.innerHTML = 'Drop strains here';
                groupContent.classList.add('empty');
                
                // Reset cross results
                const resultsContent = document.querySelector(`.cross-results-content[data-results="${groupId}"]`);
                resultsContent.innerHTML = 'Add multiple strains to see crosses';
                
                updateCrosses(groupId);
            }
            
            function removeBreedingGroup(groupId) {
                const group = document.querySelector(`.breeding-group[data-id="${groupId}"]`);
                if (group) {
                    group.remove();
                }
            }
            
            function addStrainToGroup(strainId, groupId) {
                // Find the strain in our data
                const strain = allStrains.find(s => s.id === strainId);
                if (!strain) return;
                
                const groupContent = document.querySelector(`.breeding-group-content[data-group="${groupId}"]`);
                
                // Check if this strain is already in the group
                if (groupContent.querySelector(`[data-strain-id="${strainId}"]`)) {
                    return; // Already added
                }
                
                // Clear the empty placeholder if needed
                if (groupContent.classList.contains('empty')) {
                    groupContent.innerHTML = '';
                    groupContent.classList.remove('empty');
                }
                
                const strainName = strain.STRAIN || strain.Strain || strain.Name || 'Unnamed';
                const seedType = strain['REG / FEM'] || strain.Type || '';
                
                // Create type indicators
                let typeIndicators = '';
                if (seedType.toLowerCase().includes('photo')) typeIndicators += '<span class="chip-indicator indicator-photo"></span>';
                if (seedType.toLowerCase().includes('auto')) typeIndicators += '<span class="chip-indicator indicator-auto"></span>';
                if (seedType.toLowerCase().includes('reg')) typeIndicators += '<span class="chip-indicator indicator-reg"></span>';
                if (seedType.toLowerCase().includes('fem')) typeIndicators += '<span class="chip-indicator indicator-fem"></span>';
                if (seedType.toLowerCase().includes('fast')) typeIndicators += '<span class="chip-indicator indicator-fast"></span>';
                
                const chipElement = document.createElement('div');
                chipElement.className = 'strain-chip';
                chipElement.dataset.strainId = strainId;
                chipElement.dataset.type = seedType;
                chipElement.innerHTML = `
                    <span class="strain-chip-name">${strainName}</span>
                    <span class="strain-chip-type">${typeIndicators}</span>
                    <span class="strain-chip-remove" data-remove="${strainId}">×</span>
                `;
                
                // Make it draggable for moving between groups
                chipElement.draggable = true;
                chipElement.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        id: strainId,
                        sourceGroup: groupId
                    }));
                });
                
                // Add remove functionality
                chipElement.querySelector(`.strain-chip-remove`).addEventListener('click', () => {
                    chipElement.remove();
                    if (groupContent.children.length === 0) {
                        groupContent.innerHTML = 'Drop strains here';
                        groupContent.classList.add('empty');
                    }
                    updateCrosses(groupId);
                });
                
                groupContent.appendChild(chipElement);
                updateCrosses(groupId);
            }
            
            function showGroupSelectionModal() {
                if (!selectedStrain) return;
                
                // Simple implementation - add to the first group
                // In a more complex UI, you would show a modal to let the user choose which group
                const groups = document.querySelectorAll('.breeding-group');
                if (groups.length > 0) {
                    const firstGroupId = groups[0].dataset.id;
                    addStrainToGroup(selectedStrain.id, firstGroupId);
                } else {
                    const newGroupId = addBreedingGroup();
                    addStrainToGroup(selectedStrain.id, newGroupId);
                }
            }
            
            // Crosses and Genetics
            function updateCrosses(groupId) {
                const groupContent = document.querySelector(`.breeding-group-content[data-group="${groupId}"]`);
                const resultsContent = document.querySelector(`.cross-results-content[data-results="${groupId}"]`);
                
                // Get all strains in this group
                const strainChips = groupContent.querySelectorAll('.strain-chip');
                if (strainChips.length < 2) {
                    resultsContent.innerHTML = 'Add multiple strains to see crosses';
                    return;
                }
                
                // Generate all possible crosses
                let crossesHTML = '';
                for (let i = 0; i < strainChips.length; i++) {
                    for (let j = i + 1; j < strainChips.length; j++) {
                        const strain1 = strainChips[i];
                        const strain2 = strainChips[j];
                        
                        const strain1Name = strain1.querySelector('.strain-chip-name').textContent;
                        const strain2Name = strain2.querySelector('.strain-chip-name').textContent;
                        const strain1Type = strain1.dataset.type;
                        const strain2Type = strain2.dataset.type;
                        
                        const compatibility = analyzeCompatibility(strain1Type, strain2Type);
                        const compatibilityClass = compatibility.level === 'good' ? 'compatibility-good' : 
                                                  compatibility.level === 'warning' ? 'compatibility-warning' : 
                                                  'compatibility-bad';
                        
                        crossesHTML += `
                            <div class="cross-item">
                                <div class="cross-name">${strain1Name} × ${strain2Name}</div>
                                <div class="cross-compatibility ${compatibilityClass}">
                                    ${compatibility.message}
                                </div>
                            </div>
                        `;
                    }
                }
                
                resultsContent.innerHTML = crossesHTML || 'No valid crosses found';
            }
            
            function analyzeCompatibility(type1, type2) {
                const type1Lower = (type1 || '').toLowerCase();
                const type2Lower = (type2 || '').toLowerCase();
                
                // Check for auto vs photo compatibility
                const isType1Auto = type1Lower.includes('auto');
                const isType2Auto = type2Lower.includes('auto');
                
                if (isType1Auto !== isType2Auto) {
                    return {
                        level: 'warning',
                        message: 'Caution: Mixing auto and photo genetics may produce unpredictable results'
                    };
                }
                
                // Check for feminized compatibility
                const isType1Fem = type1Lower.includes('fem');
                const isType2Fem = type2Lower.includes('fem');
                
                if (isType1Fem && isType2Fem) {
                    return {
                        level: 'warning',
                        message: 'Caution: Both are feminized, you will need to reverse one for pollen'
                    };
                }
                
                // Default case - these should work well together
                return {
                    level: 'good',
                    message: 'Good match: Compatible genetics'
                };
            }
            
            function toggleGeneticsTree() {
                // Simple placeholder - in the real implementation, you would create
                // a visualization similar to the one shown in the second image
                alert('Genetics tree visualization would be displayed here');
                
                // This would typically be a D3.js or similar visualization that you add to the page
            }
            
            // Saving and Loading
            function saveBreedingPlan() {
                const groups = document.querySelectorAll('.breeding-group');
                const savedPlan = [];
                
                groups.forEach(group => {
                    const groupId = group.dataset.id;
                    const title = group.querySelector('.breeding-group-title').value;
                    const notes = group.querySelector('.notes-field').value;
                    
                    const strains = [];
                    group.querySelectorAll('.strain-chip').forEach(chip => {
                        strains.push({
                            id: chip.dataset.strainId,
                            type: chip.dataset.type
                        });
                    });
                    
                    savedPlan.push({
                        id: groupId,
                        title: title,
                        notes: notes,
                        strains: strains
                    });
                });
                
                // Save to local storage
                localStorage.setItem('breedingPlan', JSON.stringify(savedPlan));
                alert('Breeding plan saved successfully!');
            }
            
            function loadBreedingPlan() {
                const savedPlan = localStorage.getItem('breedingPlan');
                if (!savedPlan) {
                    alert('No saved breeding plan found');
                    return;
                }
                
                try {
                    const plan = JSON.parse(savedPlan);
                    
                    // Clear existing groups
                    breedingGroups.innerHTML = '';
                    groupCounter = 0;
                    
                    // Create each group and add strains
                    plan.forEach(groupData => {
                        groupCounter++;
                        const groupId = `group-${groupCounter}`;
                        
                        // Create the group
                        const groupElement = document.createElement('div');
                        groupElement.className = 'breeding-group';
                        groupElement.dataset.id = groupId;
                        
                        groupElement.innerHTML = `
                            <div class="breeding-group-header">
                                <input type="text" class="breeding-group-title" value="${groupData.title || `Breeding Project ${groupCounter}`}">
                                <div class="breeding-group-actions">
                                    <button class="btn btn-sm btn-clear" data-action="clear" data-group="${groupId}">Clear</button>
                                    <button class="btn btn-sm btn-remove" data-action="remove" data-group="${groupId}">Remove</button>
                                </div>
                            </div>
                            <div class="breeding-group-content" data-group="${groupId}"></div>
                            <div class="cross-results">
                                <div class="cross-results-title">Potential Crosses</div>
                                <div class="cross-results-content" data-results="${groupId}"></div>
                            </div>
                            <textarea class="notes-field" placeholder="Notes about this breeding project...">${groupData.notes || ''}</textarea>
                        `;
                        
                        breedingGroups.appendChild(groupElement);
                        
                        // Add event listeners
                        const clearBtn = groupElement.querySelector('[data-action="clear"]');
                        const removeBtn = groupElement.querySelector('[data-action="remove"]');
                        
                        clearBtn.addEventListener('click', () => clearBreedingGroup(groupId));
                        removeBtn.addEventListener('click', () => removeBreedingGroup(groupId));
                        
                        // Set up drop target
                        setupGroupDropTarget(groupId);
                        
                        // Add strains
                        const groupContent = groupElement.querySelector(`.breeding-group-content[data-group="${groupId}"]`);
                        groupContent.classList.remove('empty');
                        groupContent.innerHTML = ''; // Clear the placeholder
                        
                        if (groupData.strains && groupData.strains.length > 0) {
                            groupData.strains.forEach(strainData => {
                                addStrainToGroup(strainData.id, groupId);
                            });
                        } else {
                            // Empty group
                            groupContent.innerHTML = 'Drop strains here';
                            groupContent.classList.add('empty');
                        }
                    });
                    
                    alert('Breeding plan loaded successfully!');
                } catch (error) {
                    console.error('Error loading breeding plan:', error);
                    alert('Error loading breeding plan. The saved data may be corrupted.');
                }
            }
        });
    </script>
</body>
</html>
