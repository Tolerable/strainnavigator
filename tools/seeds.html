<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Strain Explorer</title>
    <style>
        :root {
            --female-color: #ffadc6;
            --male-color: #8ab4ff;
            --self-color: #c8a2ff;
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #b9ffb8;
            --border-color: #1a4a1a;
        }
        
        body {
            margin: 0;
            background: var(--bg-color);
            color: var(--text-color);
            font-family: system-ui, -apple-system, sans-serif;
            height: 100vh;
            display: block;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 430px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 20px;
			margin-top: 20px;
			margin: 0 auto;
        }

        .strain-title {
            background: var(--card-bg);
            padding: 12px 24px;
            border-radius: 24px;
            text-align: center;
            font-size: 1.2em;
            margin: 0;
            border: 2px solid var(--border-color);
        }

        .parents {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .parent {
            flex: 1;
            padding: 12px;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            transition: opacity 0.2s;
            border: 2px solid var(--border-color);
        }

        .parent:active {
            opacity: 0.7;
        }

        .female { 
            background: var(--female-color);
            color: #2d2d2d;
        }
        
        .male { 
            background: var(--male-color);
            color: #2d2d2d;
        }

        .self {
            background: var(--self-color);
            color: #2d2d2d;
        }

        .main-image-container {
            position: relative;
            aspect-ratio: 1;
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }

        .main-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(45,45,45,0.8);
            color: var(--text-color);
            border: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.5em;
            backdrop-filter: blur(4px);
            border-radius: 20px;
            z-index: 10;
        }

        .nav-left { left: 12px; }
        .nav-right { right: 12px; }

		.offspring-container {
			position: relative;
			width: calc(25% - 9px);
		}

		.offspring-thumb {
			aspect-ratio: 1;
			width: 100%;
			background: var(--card-bg);
			border-radius: 8px;
			overflow: hidden;
			cursor: pointer;
			border: 2px solid var(--border-color);
		}

		.thumb-image {
			width: 100%;
			height: 100%;
			background-size: cover;
			background-position: center;
		}

		.offspring-label {
			position: relative;
			margin-top: 8px;
			padding-bottom: 12px;
			text-align: center;
			font-size: 12px;
			color: var(--text-color);
			line-height: 1.2;
			word-wrap: break-word;
		}

		.offspring-container {
			position: relative;
			width: calc(25% - 9px);
			display: flex;
			flex-direction: column;
		}

		.offspring {
			display: flex;
			gap: 12px;
			padding-bottom: 24px;
		}

        .offspring-thumb:hover::after {
            content: attr(data-strain);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 20;
        }

		.strain-info {
		   margin-top: 24px;
		   padding: 16px;
		   background: var(--card-bg);
		   border-radius: 8px;
		   border: 2px solid var(--border-color);
		   box-shadow: 0 2px 8px rgba(0,0,0,0.2);
		}

		.info-type {
		   display: inline-block;
		   padding: 4px 8px;
		   border-radius: 4px;
		   background: #333;
		   margin-bottom: 8px;
		   font-weight: 500;
		}

		.info-description {
		   line-height: 1.5;
		   margin: 12px 0;
		}

		.info-section {
		   border-top: 1px solid #333;
		   padding-top: 8px;
		   margin-top: 8px;
		}

		.info-label {
		   color: #666;
		   font-size: 0.9em;
		   margin-bottom: 4px;
		}

		.info-content {
		   color: var(--text-color);
		}

		.info-effects, .info-flavors {
			font-size: 0.9em;
			color: #999;
			margin: 4px 0;
		}

        .add-strain {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            opacity: 0.5;
        }

		.strain-badges {
		   position: absolute;
		   top: 8px;
		   left: 8px;
		   display: flex;
		   gap: 4px;
		   flex-wrap: wrap;
		   max-width: 80%;
		   z-index: 10;
		}

		.badge {
		   padding: 2px 8px;
		   border-radius: 12px;
		   font-size: 0.8em;
		   color: white;
		   background: rgba(0,0,0,0.7);
		   backdrop-filter: blur(4px);
		}

		.badge-photo { background: #4a90e2; }
		.badge-auto { background: #e24a90; }
		.badge-f1 { background: #90e24a; }
		.badge-f2 { background: #4ae290; }
		.badge-s1 { background: #c8a2ff; }
		.badge-bx { background: #ffa24a; }
		.badge-sativa { background: #e2904a; }
		.badge-indica { background: #4ae2e2; }
		.badge-mix { background: #e24ae2; }

		.main-image-container.loading::after {
		   content: 'Loading...';
		   position: absolute;
		   top: 50%;
		   left: 50%;
		   transform: translate(-50%, -50%);
		   color: var(--text-color);
		}

		.main-image-container.error::after {
		   content: 'Image not available';
		   position: absolute;
		   top: 50%;
		   left: 50%;
		   transform: translate(-50%, -50%);
		   color: var(--text-color);
		}

		.profile-controls {
			width: 100%;
			max-width: 430px;
			margin: 0 auto;
			display: flex;
			gap: 8px;
			padding: 10px;
			background: var(--card-bg);
			margin-bottom: 10px;
			border-radius: 8px;
			align-items: center;
		}

		.profile-icon-btn {
			width: 32px;
			height: 32px;
			padding: 0;
			border-radius: 4px;
			background: var(--bg-color);
			color: var(--text-color);
			border: 1px solid var(--border-color);
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 18px;
		}

		.profile-select {
			flex: 1;
			padding: 8px;
			border-radius: 4px;
			background: var(--bg-color);
			color: var(--text-color);
			border: 1px solid var(--border-color);
		}

		.profile-btn {
			padding: 8px 16px;
			border-radius: 4px;
			background: var(--bg-color);
			color: var(--text-color);
			border: 1px solid var(--border-color);
			cursor: pointer;
		}

		.profile-btn:hover {
			background: var(--border-color);
		}

		.modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0,0,0,0.7);
			z-index: 1000;
		}

		.modal-content {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: var(--card-bg);
			padding: 20px;
			border-radius: 8px;
			width: 80%;
			max-width: 300px;
		}

		.modal-content input {
			width: 100%;
			padding: 8px;
			margin: 10px 0;
			border-radius: 4px;
			background: var(--bg-color);
			color: var(--text-color);
			border: 1px solid var(--border-color);
		}

		.modal-content button {
			margin: 5px;
			padding: 8px 16px;
			border-radius: 4px;
			background: var(--bg-color);
			color: var(--text-color);
			border: 1px solid var(--border-color);
			cursor: pointer;
		}

		.strain-form {
			max-width: 400px;
			width: 90%;
			max-height: 90vh;
			overflow-y: auto;
		}

		.image-preview {
			width: 100%;
			aspect-ratio: 1;
			position: relative;
			margin-bottom: 1rem;
			border-radius: 8px;
			overflow: hidden;
			background: var(--bg-color);
		}

		.image-preview img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.image-actions {
		   position: absolute;
		   bottom: 10px;
		   right: 10px;
		   display: flex;
		   gap: 8px;
		}

		.icon-btn {
		   width: 40px;
		   height: 40px;
		   border-radius: 50%;
		   background: rgba(0,0,0,0.7);
		   border: none;
		   cursor: pointer;
		   font-size: 20px;
		   display: flex;
		   align-items: center;
		   justify-content: center;
		}

		.edit-btn {
			position: absolute;
			top: 10px;
			right: 10px;
			width: 40px;
			height: 40px;
			border-radius: 50%;
			background: rgba(0,0,0,0.7);
			color: var(--text-color);
			border: none;
			cursor: pointer;
			font-size: 20px;
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 20;
		}

		.info-header {
			position: relative;
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			margin-bottom: 12px;
		}

		.logo-container {
			display: flex;
			align-items: center;
			margin-left: 12px;
		}

		.breeder-logo {
			width: 60px;
			height: 60px;
			border-radius: 8px;
			overflow: hidden;
			margin-right: 8px;
		}

		.breeder-logo img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.clickable-logo {
			cursor: pointer;
			transition: transform 0.2s;
		}

		.clickable-logo:hover {
			transform: scale(1.1);
		}

		.main-image {
			cursor: pointer;
		}

		.strain-logo {
			width: 60px;
			height: 60px;
			border-radius: 8px;
			overflow: hidden;
		}

		.strain-logo img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		#strainForm {
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.form-actions {
			display: flex;
			gap: 8px;
			justify-content: flex-end;
		}
		
		@media (max-width: 600px) { /* For small devices, like Android phones */
			body {
				font-size: 14px;  /* Adjust base font size for readability */
			}

			.container {
				padding: 10px;    /* Reduce padding */
				gap: 12px;        /* Adjust gap */
			}

			.strain-title {
				font-size: 1.1em; /* Slightly smaller font size */
				padding: 8px 16px; /* Adjust padding */
			}

			.nav-btn {
				width: 35px; /* Smaller navigation button */
				height: 35px; /* Smaller navigation button */
				font-size: 1.3em; /* Adjust font size */
			}
		}

		@media (min-width: 601px) and (max-width: 960px) { /* For medium devices, like larger phones or small tablets */
			body {
				font-size: 16px; /* Normal font size */
			}

			.container {
				padding: 15px; /* Standard padding */
				gap: 14px; /* Standard gap */
			}

			.strain-title {
				font-size: 1.2em; /* Normal font size */
			}
		}
		
    </style>
</head>
<body>

	<div class="profile-controls">
		<select id="profileSelector" class="profile-select"></select>
		<button onclick="showNewProfileDialog()" class="profile-icon-btn" title="New Profile">+</button>
		<button onclick="showRenameDialog()" class="profile-icon-btn" title="Rename Profile">✎</button>
		<button onclick="confirmDeleteProfile()" class="profile-icon-btn" title="Delete Profile">🗑️</button>
	</div>

	<div id="newProfileDialog" class="modal">
		<div class="modal-content">
			<h3>Create New Profile</h3>
			<input type="text" id="newProfileName" placeholder="Profile Name">
			<button onclick="createNewProfile()">Create</button>
			<button onclick="closeNewProfileDialog()">Cancel</button>
		</div>
	</div>

	<div class="container">
	   <div class="parents">
		   <div class="parent female" onclick="loadParent(this.dataset.id)" data-id=""></div>
		   <div class="parent male" onclick="loadParent(this.dataset.id)" data-id=""></div>
	   </div>
	   
	   <div class="strain-title"></div>
	   
	   <div class="main-image-container">
		   <button class="nav-btn nav-left" onclick="prevStrain()">←</button>
		   <div class="main-image"></div>
		   <button class="nav-btn nav-right" onclick="nextStrain()">→</button>
	   </div>
	   
	   <div class="offspring"></div>
	   
	   <div class="strain-info"></div>
	</div>

	<div id="addStrainDialog" class="modal">
		<div class="modal-content strain-form">
			<h3>Add New Strain</h3>
			<div class="image-preview">
				<img id="strainImagePreview" src="./strains/no_bud_pic.jpg">
				<div class="image-actions">
					<button onclick="document.getElementById('cameraInput').click()" class="icon-btn">📷</button>
					<button onclick="document.getElementById('galleryInput').click()" class="icon-btn">🖼️</button>
				</div>
				<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none">
				<input type="file" id="galleryInput" accept="image/*" style="display: none">
			</div>
			
			<form id="strainForm">
				<input type="text" id="strainName" placeholder="Strain Name" required>
				<input type="text" id="strainShortName" placeholder="Short Name">
				<select id="strainType" required>
					<option value="">Select Type</option>
					<option value="Sativa">Sativa</option>
					<option value="Indica">Indica</option>
					<option value="Hybrid">Hybrid</option>
				</select>
				<select id="photoperiod" required>
					<option value="">Photoperiod Type</option>
					<option value="Photo">Photoperiod</option>
					<option value="Auto">Autoflower</option>
				</select>
				<select id="mother">
					<option value="">Select Mother (Optional)</option>
				</select>
				<select id="father">
					<option value="">Select Father (Optional)</option>
				</select>
				<input type="text" id="thc" placeholder="THC % (Optional)">
				<input type="text" id="cbd" placeholder="CBD % (Optional)">
				<input type="number" id="floweringDays" placeholder="Flowering Days (Optional)" min="1" max="200">
				<textarea id="description" placeholder="Description" rows="3"></textarea>
				<div class="effects-container">
					<input type="text" id="effects" placeholder="Effects (comma separated)">
				</div>
				<div class="flavors-container">
					<input type="text" id="flavors" placeholder="Flavors (comma separated)">
				</div>
				<div class="form-actions">
					<button type="submit">Save</button>
					<button type="button" onclick="closeAddStrainDialog()">Cancel</button>
				</div>
			</form>
			
		</div>
	</div>

    <script>
let strains = [];
let strainInfo = {};
let currentIndex = 0;
let currentStrain = null;
let currentMainImage = null;

const STORAGE_KEY = 'strainTrackerData';
const defaultData = {
    activeProfile: null,
    profiles: {},
    lastBackup: null
};

const defaultProfile = {
    name: '',
    strains: [],
    customStrainInfo: {},
    created: null,
    lastModified: null
};

// Create and update database
const dbName = 'StrainTrackerDB';
const dbVersion = 1;

// Initialize the database
function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(dbName, dbVersion);
        
        request.onerror = () => reject(request.error);
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('strainData')) {
                db.createObjectStore('strainData', { keyPath: 'profileId' });
            }
        };
        
        request.onsuccess = () => resolve(request.result);
    });
}

// Save data to IndexedDB
async function saveData(data) {
    try {
        const db = await initDB();
        const tx = db.transaction('strainData', 'readwrite');
        const store = tx.objectStore('strainData');
        await store.put({
            profileId: data.activeProfile,
            ...data
        });
        return new Promise((resolve, reject) => {
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    } catch (error) {
        console.error('Error saving data:', error);
        throw error;
    }
}

// Load data from IndexedDB
async function loadData() {
    try {
        const db = await initDB();
        const tx = db.transaction('strainData', 'readonly');
        const store = tx.objectStore('strainData');
        const request = store.getAll();
        
        return new Promise((resolve, reject) => {
            request.onsuccess = () => {
                const data = request.result[0] || {
                    activeProfile: 'default',
                    profiles: {
                        'default': {
                            name: 'Highwayman',
                            strains: [],
                            customStrainInfo: {},
                            focalStrain: 'hwm-001',
                            created: new Date().toISOString(),
                            lastModified: new Date().toISOString()
                        },
                        'glicious': {
                            name: 'G-Licious',
                            strains: [],
                            customStrainInfo: {},
                            focalStrain: 'gl-s3-001',
                            created: new Date().toISOString(),
                            lastModified: new Date().toISOString()
                        }
                    }
                };
                resolve(data);
            };
            request.onerror = () => reject(request.error);
        });
    } catch (error) {
        console.error('Error loading data:', error);
        throw error;
    }
}

// Replace your existing initializeStorage function with this
async function initializeStorage() {
    try {
        const data = await loadData();
        return data;
    } catch (error) {
        console.error('Error initializing storage:', error);
        // Return default data if loading fails
        return {
            activeProfile: 'default',
            profiles: {
                'default': {
                    name: 'Highwayman',
                    strains: [],
                    customStrainInfo: {},
                    focalStrain: 'hwm-001',
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                },
                'glicious': {
                    name: 'G-Licious',
                    strains: [],
                    customStrainInfo: {},
                    focalStrain: 'gl-s3-001',
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                }
            }
        };
    }
}

function initCamera() {
    const constraints = {
        video: {
            facingMode: 'environment',
            aspectRatio: 1,
            width: { ideal: 1080 },
            height: { ideal: 1080 }
        }
    };
    
    if ('mediaDevices' in navigator) {
        navigator.mediaDevices.getUserMedia(constraints)
            .then(stream => {
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                track.applyConstraints({
                    aspectRatio: 1,
                    width: capabilities.width.max,
                    height: capabilities.width.max
                });
            })
            .catch(err => console.error('Camera error:', err));
    }
}

async function switchProfile(profileId) {
    const data = await loadData();
    if (data.profiles[profileId]) {
        data.activeProfile = profileId;
        await saveData(data);
        await loadStrainData();
        return true;
    }
    return false;
}

function showStrainDialog(editStrain = null) {
   const dialog = document.getElementById('addStrainDialog');
   const title = document.querySelector('#addStrainDialog h3');
   const form = document.getElementById('strainForm');
   const submitBtn = form.querySelector('button[type="submit"]');
   
   title.textContent = editStrain ? 'Edit Strain' : 'Add New Strain';
   submitBtn.textContent = editStrain ? 'Save Changes' : 'Save';
   
   // Update parent selectors
   updateParentSelectors(editStrain?.id);
   
   if (editStrain) {
       const info = strainInfo[editStrain.id];
       document.getElementById('strainName').value = editStrain.strain;
       document.getElementById('strainShortName').value = editStrain.shortName || '';
       document.getElementById('strainType').value = editStrain.type || '';
       document.getElementById('photoperiod').value = info?.photoperiod || '';
       document.getElementById('mother').value = editStrain.mother || '';
       document.getElementById('father').value = editStrain.father || '';
       document.getElementById('description').value = info?.description || '';
       document.getElementById('thc').value = info?.thc || '';
       document.getElementById('cbd').value = info?.cbd || '';
	   document.getElementById('floweringDays').value = info?.floweringDays || '';
       document.getElementById('effects').value = info?.effects?.join(', ') || '';
       document.getElementById('flavors').value = info?.flavors?.join(', ') || '';
       
       if (editStrain.imageData) {
           document.getElementById('strainImagePreview').src = editStrain.imageData;
       } else if (editStrain.image) {
           document.getElementById('strainImagePreview').src = editStrain.image;
       }
       
       form.dataset.editId = editStrain.id;
   } else {
       form.reset();
       document.getElementById('strainImagePreview').src = './strains/no_bud_pic.jpg';
       delete form.dataset.editId;
   }
   
   dialog.style.display = 'block';
}

function exportData() {
    const data = localStorage.getItem(STORAGE_KEY);
    const blob = new Blob([data], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `strain-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function importData(jsonFile) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data.profiles && data.activeProfile) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    resolve(true);
                } else {
                    reject(new Error('Invalid backup file format'));
                }
            } catch (err) {
                reject(err);
            }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsText(jsonFile);
    });
}

function showNewProfileDialog() {
    document.getElementById('newProfileDialog').style.display = 'block';
}

function closeNewProfileDialog() {
    document.getElementById('newProfileDialog').style.display = 'none';
    document.getElementById('newProfileName').value = '';
}

async function createProfile(name) {
    const data = await loadData();
    const profileId = 'profile_' + Date.now();
    
    data.profiles[profileId] = {
        name: name,
        strains: [],
        customStrainInfo: {},
        created: new Date().toISOString(),
        lastModified: new Date().toISOString()
    };
    
    data.activeProfile = profileId;
    await saveData(data);
    return profileId;
}

function createNewProfile() {
    const name = document.getElementById('newProfileName').value.trim();
    if (name) {
        createProfile(name);
        closeNewProfileDialog();
        updateProfileSelector();
        loadStrainData();
    }
}

async function handleImageUpload(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            resolve(e.target.result); // Return the base64 data URL
        };
        reader.readAsDataURL(file);
    });
}

function handleImageInput(input) {
    const file = input.files[0];
    if (!file) return;

    handleImageUpload(file)
        .then(result => {
            document.getElementById('strainImagePreview').src = result;
        })
        .catch(err => {
            console.error('Image error:', err);
            alert(err.message || 'Failed to process image');
            input.value = '';
        });
}

async function addNewStrain(strainData, imageFile) {
   const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
   const activeProfile = data.profiles[data.activeProfile];
   const strainId = `strain_${Date.now()}`;
   let imageData = null;
   
   if (imageFile) {
       imageData = await handleImageUpload(imageFile);
   }
   
   const newStrain = {
       id: strainId,
       strain: strainData.name,
       shortName: strainData.shortName || strainData.name,
       mother: strainData.mother || null,
       father: strainData.father || null,
       type: strainData.type,
       imageData: imageData // Store as imageData property
   };
   
   activeProfile.strains.push(newStrain);
   activeProfile.customStrainInfo[strainId] = {
       type: strainData.type,
       description: strainData.description,
       photoperiod: strainData.photoperiod,
       thc: strainData.thc || '',
       cbd: strainData.cbd || '',
       effects: strainData.effects ? strainData.effects.split(',').map(e => e.trim()) : [],
       flavors: strainData.flavors ? strainData.flavors.split(',').map(f => f.trim()) : []
   };

   activeProfile.lastModified = new Date().toISOString();
   saveData(data);
   await loadStrainData();
}

function showAddStrainDialog() {
    document.getElementById('addStrainDialog').style.display = 'block';
    document.getElementById('strainImagePreview').src = './strains/no_bud_pic.jpg';
}

function closeAddStrainDialog() {
    document.getElementById('addStrainDialog').style.display = 'none';
    document.getElementById('strainForm').reset();
}

async function showRenameDialog() {
    const data = await loadData();
    const profile = data.profiles[data.activeProfile];
    const newName = prompt("Enter new name:", profile.name);
    if (newName?.trim()) {
        profile.name = newName.trim();
        await saveData(data);
        updateProfileSelector();
    }
}

async function confirmDeleteProfile() {
    const data = await loadData();
    if (data.activeProfile === 'default') {
        alert("Cannot delete default profile");
        return;
    }
    if (confirm("Delete this profile?")) {
        if (data.profiles[data.activeProfile]) {
            delete data.profiles[data.activeProfile];
            data.activeProfile = 'default';
            await saveData(data);
            await loadStrainData();
            updateProfileSelector();
        }
        window.location.reload(); // Force complete reset
    }
}

async function updateProfileSelector() {
    const selector = document.getElementById('profileSelector');
    const data = await loadData();
    
    selector.innerHTML = '';
    Object.entries(data.profiles).forEach(([id, profile]) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = profile.name;
        option.selected = id === data.activeProfile;
        selector.appendChild(option);
    });
}

async function updateParentSelectors(excludeId = null) {
    const data = await loadData();
    const activeProfile = data.profiles[data.activeProfile];
    const strains = activeProfile.strains;
    
    ['mother', 'father'].forEach(parentType => {
        const select = document.getElementById(parentType);
        select.innerHTML = `<option value="">Select ${parentType}</option>`;
        
        strains.forEach(strain => {
            if (strain.id !== excludeId) {
                const option = document.createElement('option');
                option.value = strain.id;
                option.textContent = strain.strain;
                select.appendChild(option);
            }
        });
    });
}

function getBadges(strain) {
    const badges = [];
    const info = strainInfo[strain.id];

    // Generation badges
    if (strain.type === 'feminized') {
        badges.push('S1');
    } else if (strain.father?.includes('-silver')) {
        const genNum = strain.father.match(/b(\d+)/i)?.[1] || '1';
        badges.push(`B${genNum}`);
    } else if (strain.type === 'backcross') {
        const parent = strains.find(s => s.id === strain.father.replace('-male', ''));
        badges.push(`Bx1 (${parent?.shortName || ''})`);
    } else if (strain.type === 'f2') {
        badges.push('F2');
    } else if (strain.mother && strain.father) {
        badges.push('F1');
    }

    if (info?.photoperiod) {
        badges.push(info.photoperiod);
    }

    return badges;
}

function updateBadges(strain) {
    const mainImage = document.querySelector('.main-image-container');
    const oldBadges = mainImage.querySelector('.strain-badges');
    if (oldBadges) oldBadges.remove();

    const badgeContainer = document.createElement('div');
    badgeContainer.className = 'strain-badges';
    
    getBadges(strain).forEach(badge => {
        const div = document.createElement('div');
        const className = badge.toLowerCase().split(' ')[0];
        div.className = `badge badge-${className}`;
        div.textContent = badge;
        badgeContainer.appendChild(div);
    });

    mainImage.appendChild(badgeContainer);
}

async function getImageUrl(strain) {
    if (!strain) return null;
    if (strain.imageData) return strain.imageData; // Handle base64 data
    if (!strain.image) return './strains/no_bud_pic.jpg'; // Default image path

    // Handle file paths
    const imagePath = strain.image.startsWith('/tools/') ? 
        strain.image.replace('/tools/', './') : 
        strain.image;

    try {
        const response = await fetch(imagePath);
        return response.ok ? imagePath : './strains/no_bud_pic.jpg';
    } catch {
        return './strains/no_bud_pic.jpg'; // Use default image if fetch fails
    }
}

async function loadStrain(id) {
    if (!id || strains.length === 0) {
        updateDisplayForEmptyProfile();
        const mainImage = document.querySelector('.main-image-container');
        mainImage.onclick = showAddStrainDialog;
        return;
    }
    
    const strain = strains.find(p => p.id === id);
    if (!strain || strain.id === undefined) {
        // Stay on current strain if invalid parent clicked
        if (currentStrain) {
            return;
        }
        updateDisplayForEmptyProfile();
        return;
    }
    
    currentStrain = strain;
    document.querySelector('.strain-title').textContent = strain.strain;
    const parents = document.querySelector('.parents');
    parents.innerHTML = '';

    if (!strain.mother && !strain.father) {
        parents.style.display = 'none';
    } else {
        parents.style.display = 'flex';
        
        if (strain.father?.includes('-silver')) {
            const self = document.createElement('div');
            self.className = 'parent self';
            const motherStrain = strains.find(s => s.id === strain.mother);
            self.textContent = `Self: ${motherStrain?.strain || strain.mother}`;
            self.dataset.id = strain.mother;
            self.onclick = () => loadParent(strain.mother);
            parents.appendChild(self);
        } else {
            if (strain.mother) {
                const mother = document.createElement('div');
                mother.className = 'parent female';
                const motherStrain = strains.find(s => s.id === strain.mother);
                mother.textContent = `Mother: ${motherStrain?.strain || strain.mother}`;
                mother.dataset.id = strain.mother;
                mother.onclick = () => loadParent(strain.mother);
                parents.appendChild(mother);
            }
            
            if (strain.father) {
                const father = document.createElement('div');
                father.className = 'parent male';
                const fatherBaseName = strain.father.replace('-male', '');
                const fatherStrain = strains.find(s => s.id === fatherBaseName);
                father.textContent = `Father: ${fatherStrain?.strain || strain.father}`;
                father.dataset.id = strain.father;
                father.onclick = () => loadParent(fatherBaseName);
                parents.appendChild(father);
            }
        }
    }

    const mainImageContainer = document.querySelector('.main-image-container');
    const mainImage = document.querySelector('.main-image');
    
    // Remove any existing edit button
    const existingBtn = mainImageContainer.querySelector('.edit-btn');
    if (existingBtn) existingBtn.remove();
    
    const editBtn = document.createElement('button');
    editBtn.className = 'edit-btn';
    editBtn.innerHTML = '✎';
    editBtn.onclick = (e) => {
        e.stopPropagation();
        showStrainDialog(strain);
    };
    mainImageContainer.appendChild(editBtn);
    
    const imageUrl = await getImageUrl(strain);
    mainImage.style.backgroundImage = imageUrl ? `url("${imageUrl}")` : 'none';
	currentMainImage = mainImage.style.backgroundImage;
    mainImage.style.backgroundSize = 'cover';
    mainImage.textContent = imageUrl ? '' : 'No image available';
    
	currentMainImage = mainImage.style.backgroundImage;
	delete mainImage.dataset.showingLogo;
	document.querySelector('.nav-btn.nav-left').style.display = '';
	document.querySelector('.nav-btn.nav-right').style.display = '';	
	
    updateBadges(strain);
    await updateOffspring(strain.id);
    updateStrainInfo(strain);
}

async function loadStrainData() {
    try {
        const data = await initializeStorage();
        const activeProfile = data.profiles[data.activeProfile];
        
        if ((!activeProfile.strains || !activeProfile.strains.length)) {
            const response = await fetch('./strains/strainInfo.json');
            const strainInfoData = await response.json();
            strainInfo = strainInfoData.info;

            const strainsResponse = await fetch('./strains/strains.json');
            const strainsData = await strainsResponse.json();
            strains = strainsData.strains;

            activeProfile.strains = strains;
            activeProfile.customStrainInfo = strainInfo;
            await saveData(data);
        } else {
            strains = activeProfile.strains;
            strainInfo = activeProfile.customStrainInfo;
        }

        // Use focal strain if available, otherwise use defaults
        if (activeProfile.focalStrain) {
            currentIndex = strains.findIndex(s => s.id === activeProfile.focalStrain);
        } else if (data.activeProfile === 'default') {
            currentIndex = strains.findIndex(s => s.id === 'hwm-001');
        } else {
            currentIndex = 0;
        }
        
        if (currentIndex === -1) currentIndex = 0;
        
        if (strains.length) {
            await loadStrain(strains[currentIndex].id);
        } else {
            updateDisplayForEmptyProfile();
        }
    } catch (err) {
        console.error('Error loading data:', err);
    }
}

async function updateOffspring(parentId) {
    const container = document.querySelector('.offspring');
    container.innerHTML = '';
    
    console.log("Looking for children of:", parentId);
    
    const children = strains.filter(strain => {
        console.log("Checking strain:", strain.id, {
            mother: strain.mother,
            father: strain.father,
            isMatch: (
                strain.mother === parentId || 
                strain.father === parentId || 
                strain.father === `${parentId}-male` || 
                strain.father === `${parentId}-silver`
            )
        });
        
        return (
            strain.mother === parentId || 
            strain.father === parentId || 
            strain.father === `${parentId}-male` || 
            strain.father === `${parentId}-silver`
        );
    });
    
    console.log("Found children:", children.map(c => c.strain));

    for (const child of children) {
        const thumbContainer = document.createElement('div');
        thumbContainer.className = 'offspring-container';
        
        const thumb = document.createElement('div');
        thumb.className = 'offspring-thumb';
        thumb.onclick = () => loadStrain(child.id);
        thumb.title = child.strain;
        
        const img = document.createElement('div');
        img.className = 'thumb-image';
        const imgUrl = await getImageUrl(child);
        img.style.backgroundImage = imgUrl ? `url("${imgUrl}")` : 'none';
        
        const label = document.createElement('div');
        label.className = 'offspring-label';
        label.textContent = child.strain;
        
        thumb.appendChild(img);
        thumbContainer.appendChild(thumb);
        thumbContainer.appendChild(label);
        container.appendChild(thumbContainer);
    }

    // Add empty slots
    const emptySlots = 4 - children.length;
    for (let i = 0; i < emptySlots; i++) {
        const thumbContainer = document.createElement('div');
        thumbContainer.className = 'offspring-container';
        
        const empty = document.createElement('div');
        empty.className = 'offspring-thumb add-strain';
        empty.innerHTML = '+';
        empty.onclick = showAddStrainDialog;
        
        thumbContainer.appendChild(empty);
        container.appendChild(thumbContainer);
    }
}

async function compressAndHandleImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Target max size 800x800
                const maxSize = 800;
                if (width > maxSize || height > maxSize) {
                    if (width > height) {
                        height = Math.round((height * maxSize) / width);
                        width = maxSize;
                    } else {
                        width = Math.round((width * maxSize) / height);
                        height = maxSize;
                    }
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Compress with quality 0.8
                const compressedData = canvas.toDataURL('image/jpeg', 0.8);
                resolve(compressedData);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

function updateStrainInfo(strain) {
    const infoContainer = document.querySelector('.strain-info');
    const info = strainInfo[strain.id];
    
    if (info) {
        infoContainer.innerHTML = `
            <div class="info-header">
                <div class="info-type">${info.type || strain.type}</div>
                <div class="logo-container">
                    ${strain.breederLogo ? `
                        <div class="breeder-logo">
                            <img src="${strain.breederLogo}" alt="Breeder logo" class="clickable-logo">
                        </div>
                    ` : ''}
                    ${strain.logo ? `
                        <div class="strain-logo">
                            <img src="${strain.logo}" alt="${strain.strain} logo" class="clickable-logo">
                        </div>
                    ` : ''}
                </div>
            </div>
            ${info.thc ? `<div class="info-thc">THC: ${info.thc}</div>` : ''}
            ${info.cbd ? `<div class="info-cbd">CBD: ${info.cbd}</div>` : ''}
            ${info.floweringDays ? `<div class="info-flowering">Flowering Time: ${info.floweringDays} days</div>` : ''}
            <p class="info-description">${info.description}</p>
            ${info.effects ? `
                <div class="info-section">
                    <div class="info-label">Effects</div>
                    <div class="info-content">${info.effects.join(', ')}</div>
                </div>
            ` : ''}
            ${info.flavors ? `
                <div class="info-section">
                    <div class="info-label">Flavors</div>
                    <div class="info-content">${info.flavors.join(', ')}</div>
                </div>
            ` : ''}
        `;
        
        // Add event listeners to logo images
        const logoImages = infoContainer.querySelectorAll('.clickable-logo');
        logoImages.forEach(img => {
            img.addEventListener('click', function() {
                const mainImage = document.querySelector('.main-image');
                
                // If already showing a logo, restore the original image
                if (mainImage.dataset.showingLogo) {
                    // Restore original image
                    mainImage.style.backgroundImage = currentMainImage;
                    delete mainImage.dataset.showingLogo;
                    
                    // Show navigation buttons again
                    document.querySelector('.nav-btn.nav-left').style.display = '';
                    document.querySelector('.nav-btn.nav-right').style.display = '';
                } else {
                    // Save the current strain image
                    // currentMainImage is already set in loadStrain
                    
                    // Show the logo in the main image area
                    mainImage.style.backgroundImage = `url("${this.src}")`;
                    mainImage.dataset.showingLogo = "true";
                    
                    // Hide navigation buttons while showing logo
                    document.querySelector('.nav-btn.nav-left').style.display = 'none';
                    document.querySelector('.nav-btn.nav-right').style.display = 'none';
                }
            });
        });
        
        // Make the main image clickable to restore from logo view
        const mainImage = document.querySelector('.main-image');
        mainImage.addEventListener('click', function() {
            if (this.dataset.showingLogo) {
                // Restore original image
                this.style.backgroundImage = currentMainImage;
                delete this.dataset.showingLogo;
                
                // Show navigation buttons again
                document.querySelector('.nav-btn.nav-left').style.display = '';
                document.querySelector('.nav-btn.nav-right').style.display = '';
            }
        });
        
        infoContainer.style.display = 'block';
    } else {
        infoContainer.style.display = 'none';
    }
}

async function updateStrain(strainId, strainData, imageFile) {
   const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
   const activeProfile = data.profiles[data.activeProfile];
   
   const strain = activeProfile.strains.find(s => s.id === strainId);
   if (!strain) return;
   
   if (imageFile) {
       strain.imageData = await handleImageUpload(imageFile);
   }
   
   strain.strain = strainData.name;
   strain.shortName = strainData.shortName;
   strain.type = strainData.type;
   strain.mother = strainData.mother || null;
   strain.father = strainData.father || null;
   
   activeProfile.customStrainInfo[strainId] = {
       type: strainData.type,
       description: strainData.description,
       photoperiod: strainData.photoperiod,
       thc: strainData.thc || '',
       cbd: strainData.cbd || '',
       effects: strainData.effects ? strainData.effects.split(',').map(e => e.trim()) : [],
       flavors: strainData.flavors ? strainData.flavors.split(',').map(f => f.trim()) : []
   };
   
   activeProfile.lastModified = new Date().toISOString();
   saveData(data);
   await loadStrainData();
}

function loadParent(parentId) {
    if (parentId) {
        loadStrain(parentId);
    }
}

function updateDisplayForEmptyProfile() {
   document.querySelector('.parents').style.display = 'none';
   document.querySelector('.strain-title').textContent = 'No strains yet';
   document.querySelector('.main-image').style.backgroundImage = 'none';
   document.querySelector('.main-image').textContent = 'Add your first strain';
   document.querySelector('.strain-info').style.display = 'none';
   
   // Clear badges
   const oldBadges = document.querySelector('.strain-badges');
   if (oldBadges) oldBadges.remove();
   
   // Update offspring slots
   const container = document.querySelector('.offspring');
   container.innerHTML = '';
   for (let i = 0; i < 4; i++) {
       const thumbContainer = document.createElement('div');
       thumbContainer.className = 'offspring-container';
       const empty = document.createElement('div');
       empty.className = 'offspring-thumb add-strain';
       empty.innerHTML = '+';
       empty.onclick = showAddStrainDialog;
       thumbContainer.appendChild(empty);
       container.appendChild(thumbContainer);
   }
}

// Modify prevStrain/nextStrain
function prevStrain() {
    if (strains.length === 0) return;
    currentIndex = (currentIndex - 1 + strains.length) % strains.length;
    loadStrain(strains[currentIndex].id);
}

function nextStrain() {
    if (strains.length === 0) return;
    currentIndex = (currentIndex + 1) % strains.length;
    loadStrain(strains[currentIndex].id);
}

document.addEventListener('DOMContentLoaded', function() {
	initializeStorage();
	updateProfileSelector();
	loadStrainData();

	// Profile selector
	document.getElementById('profileSelector').addEventListener('change', function(e) {
	   switchProfile(e.target.value);
	});

	// Navigation
	document.addEventListener('keydown', (e) => {
	   if (e.key === 'ArrowLeft') prevStrain();
	   if (e.key === 'ArrowRight') nextStrain();
	});

	// Touch navigation
	const mainImage = document.querySelector('.main-image-container');
	let touchStartX = 0;
	mainImage.addEventListener('touchstart', e => touchStartX = e.touches[0].clientX);
	mainImage.addEventListener('touchend', e => {
	   const diff = touchStartX - e.changedTouches[0].clientX;
	   if (Math.abs(diff) > 50) {
		   if (diff > 0) nextStrain();
		   else prevStrain();
	   }
	});

	// Add strain form
	document.getElementById('strainForm').addEventListener('submit', async function(e) {
	   e.preventDefault();
	   const editId = this.dataset.editId;
	   
		const strainData = {
			name: document.getElementById('strainName').value,
			shortName: document.getElementById('strainShortName').value,
			type: document.getElementById('strainType').value,
			photoperiod: document.getElementById('photoperiod').value,
			mother: document.getElementById('mother').value,
			father: document.getElementById('father').value,
			description: document.getElementById('description').value,
			thc: document.getElementById('thc').value,
			cbd: document.getElementById('cbd').value,
			floweringDays: document.getElementById('floweringDays').value,
			effects: document.getElementById('effects').value,
			flavors: document.getElementById('flavors').value
		};
	   
	   const imageFile = document.getElementById('cameraInput').files[0] || 
						document.getElementById('galleryInput').files[0];
	   
	   if (editId) {
		   await updateStrain(editId, strainData, imageFile);
	   } else {
		   await addNewStrain(strainData, imageFile);
	   }
	   closeAddStrainDialog();
	});

	document.getElementById('cameraInput').addEventListener('click', initCamera);

	// Image upload handlers
	document.getElementById('cameraInput').addEventListener('change', function() {
	   handleImageInput(this);
	});
	document.getElementById('galleryInput').addEventListener('change', function() {
	   handleImageInput(this);
	});
});
    </script>
</body>
</html>